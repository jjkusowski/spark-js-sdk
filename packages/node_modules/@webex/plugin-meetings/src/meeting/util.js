import {isEmpty} from 'lodash';

import Media from '../media';

const MeetingUtil = {};

MeetingUtil.parseLocus = (response) => {
  const parsed = {};
  // First todo: add check for existance
  parsed.locus = response.body.locus;
  parsed.mediaConnections = response.body.mediaConnections;
  parsed.locusUrl = parsed.locus.url;
  parsed.locusId = parsed.locus.url.split('/').pop();
  parsed.selfId = parsed.locus.self.id;

  // we need mediaId before making roap calls
  parsed.mediaConnections.forEach((mediaConnection) => {
    if (mediaConnection.mediaId) {
      parsed.mediaId = mediaConnection.mediaId;
    }
  });
  return parsed;
};

MeetingUtil.remoteUpdateAudioVideo = (audio, video, meeting) => {
  if (!meeting) {
    return Promise.reject(new Error('You need a meeting object.'));
  }
  const localMedias = Media.generateLocalMedias(meeting.mediaId, audio, video);
  if (isEmpty(localMedias)) {
    return Promise.reject(new Error('You need a media id on the meeting to change remote audio.'));
  }
  return meeting.meetingRequest.remoteAudioVideoToggle({
    locusUrl: meeting.locusUrl,
    selfId: meeting.selfId,
    localMedias,
    deviceUrl: meeting.deviceUrl,
    correlationId: meeting.correlationId
  });
};

MeetingUtil.leaveMeeting = (meeting) => {
  if (!meeting) {
    return Promise.reject(new Error('You need a meeting object.'));
  }
  return meeting.meetingRequest.leaveMeeting({
    locusUrl: meeting.locusUrl,
    selfId: meeting.selfId,
    correlationId: meeting.correlationId,
    resourceId: null,
    deviceUrl: meeting.deviceUrl
  });
};

MeetingUtil.joinMeeting = (meeting) => {
  if (!meeting) {
    return Promise.reject(new Error('You need a meeting object.'));
  }
  // eslint-disable-next-line no-warning-comments
  // TODO: check if the meeting is in JOINING state
  // if Joining state termintate the request as user might click multiple times
  return meeting.meetingRequest
    .joinMeeting({
      sipUri: meeting.sipUri,
      deviceUrl: meeting.deviceUrl,
      locusUrl: meeting.locusUrl,
      correlationId: meeting.id,
      resourceId: meeting.resourceId
    })
    .then((res) => MeetingUtil.parseLocus(res));
};

MeetingUtil.getSdps = (meeting) => {
  const sdps = [];

  if (meeting.mediaPeerConnection) {
    sdps.push(meeting.mediaPeerConnection.sdp);
  }

  if (meeting.sharePeerConnection) {
    sdps.push(meeting.sharePeerConnection.sdp);
  }

  return sdps;
};

export default MeetingUtil;
